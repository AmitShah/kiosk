<!doctype html manifest="kiosk.appcache">
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Promo Network</title>
	<meta name="description" content="">
	<meta name="author" content="">

	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" href="{{ static_url("css/main.css")}}">
	
	<script src="{{ static_url("js/libs/modernizr-2.0.6.min.js")}}"></script>
	<script src="{{ static_url("js/libs/jquery-1.10.2.min.js")}}"></script>
	<script src="{{ static_url("js/libs/bootstrap.min.js")}}"></script>
	<script src="{{ static_url("js/libs/handlebars.js")}}"></script>
	<script src="{{ static_url("js/main.js")}}"></script>
</head>
<body>
	<div class="header-outer">
		<div class="header-background">
			<img style="width: 100%" src="{{ static_url("img/the-bay.jpg") }}"></img>
		</div>
	</div>
	<div class="status" id="status">
		connecting...
	</div>
	<div class="title">
		Coupon <br/>
		Network
	</div>
	
	<div class="my-coupons">

		<div class="saved-text"><span id="couponCount"></span> Coupons Saved</div>
		<div class="expand-arrow" id="expandMyCoupons">
			<img src="{{ static_url("img/expand-arrow-down.png") }}" style="width:100%; height:100%;"></img>
		</div>
	</div>
	<div style="position:absolute; top: 130px; width: 100%;	height:50px;">
		<div class="collected-coupons" id="collected-coupons">
			<div class="collected-coupon">
				test
			</div>
		</div>
	</div>
	<div class="available-coupons">
		<h1>Available Coupons</h1>		
		<div id="coupons" class="coupon-images"></div>	
	</div>

</body>
<script type="text/javascript">
	//Extend Modernizr
	

	if (Modernizr.localStorage){
		//local storage is available
	}else{
		//output coupons will not be saved :( 
	}
	
	var runApp = function(){
		//creating streaming connection for future use case
				
		try{
		
			var ws = new WebSocket("ws://10.0.0.1:8080/activate");
			ws.onopen = function() {
			  $('#status').html('connection established...'); 	
			  		   
			};
			ws.onmessage = function (evt)
			{
			  
			};
			ws.onclose = function()
			{
			  // websocket is closed.
			  retry();
			};
		}catch(e) {
			$('#status').html('web socket error...'); 	
			retry();
		}
		
		//retrieve current offers available from kiosk
		$.ajax({
		  url: '/coupon',
		  dataType:'json',
		  cache:'false',
		  //data: data,
		  success: function(data){

		      $('#couponCount').html(localStorage.length);
		  	  
		      var coupons = $('#coupons');
		      coupons.find('.coupon-img').remove();//remove all coupons previously available
		      for(var key in data){
		      	var str = '';
		      	if(localStorage.getItem(key) === null){
				str = '<div id="'+key+'" class="coupon-img"></div>';
				
			}else{
				str = '<div id="'+key+'" class="coupon-img acquired"></div>';
			}  
			coupons.append(str);
			var div = coupons.find('#'+key);
			var width = div[0].width();
		      	if(localStorage.getItem(key) === null){
				str = '<img class="base64-coupon" src="data:image/jpeg;base64,'+data[key]+'" style="width:'+width+'"/>';
				
			}else{
				str = '<img class="base64-coupon coupon-image" src="data:image/jpeg;base64,'+data[key]+'" style="width:'+width+'" />';
			}  
			coupons.append(str);    	
		      }
		  },
		  error: function(e){
		  	$('#status').html('waiting for kiosk');
		  }
		  
		});
		
	}
	
	var retry = function(){
		$('#status').html('waiting for connection...');
		setTimeout(runApp, 1000);
	}
	
		
	//setup global handlers
	$('.my-coupons').click(function(e){
		
		toggleMenu();
		
		  	  
	});
	var handler = $('#coupons').delegate('img', 'click', function(e){
			e.preventDefault();
			//todo:update local storage
			elem = $(this);		
			
			var srcImage = elem[0].src;
			localStorage.setItem(elem[0].id,elem[0].src);
			$('#couponCount').html(localStorage.length);
			
			
	});
	
	
	$(document).ready(function(){
		runApp();
	});

	
</script>


</html>
