<!doctype html manifest="kiosk.appcache">
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Promo Network</title>
	<meta name="description" content="">
	<meta name="author" content="">

	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" href="{{ static_url("css/style.css")}}">
	
	
	<script src="{{ static_url("js/libs/modernizr-2.0.6.min.js")}}"></script>
	<script src="{{ static_url("js/libs/jquery-1.10.2.min.js")}}"></script>
	<script src="{{ static_url("js/libs/handlebars.js")}}"></script>
	
	<script src="{{static_url("js/main.js")}}"></script>
</head>
<body>

	<div id="header-container">
		<header class="wrapper clearfix">
			<h1 id="title">Coupon Network</h1>
			<nav>
				<ul>
					<li id="my-coupon-btn"><a id="myCoupons" href="#">My Coupons (<span id="couponCount"></span>)</a></li>
				</ul>
			</nav>
		</header>
		
	</div>
	<div id="main-container">
		<div id="my-coupons" class="my-coupons">
			Test<br />
			Test<br />
			Test<br />
			Test<br />
			Test<br />
		</div>
		<div id="main" class="wrapper clearfix">
			<article id="article">
				<header>
					<h1 id="status">Header</h1>
				</header>
				<!--section class="active">
					<div class="check-active" style="position:absolute;"><img src="{{ static_url("img/check.png")}}"></img></div>
					<div class="coupon-inner inactive">
						<img class="coupon-image" src="{{ static_url("img/axe.jpg")}}"></img>
					</div>
				</section>
				<section class="active">
					<div class="check-active" style="position:absolute;"><img src="{{ static_url("img/check.png")}}"></img></div>
					<div class="coupon-inner inactive">
						<img class="coupon-image" src="{{ static_url("img/loreal.jpg")}}"></img>
					</div>
				</section>
				<section>
					<div class="check-inactive" style="position:absolute;"><img src="{{ static_url("img/check.png")}}"></img></div>
					<div class="coupon-inner">
						<img class="coupon-image" src="{{ static_url("img/axe.jpg")}}"></img>
					</div>
				</section>
				<section class="active">
					<div class="check-active" style="position:absolute;"><img src="{{ static_url("img/check.png")}}"></img></div>
					<div class="coupon-inner inactive">
						<img class="coupon-image" src="{{ static_url("img/loreal.jpg")}}"></img>
					</div>
				</section-->
				
			</article>
			
		</div> <!-- #main -->
	</div> <!-- #main-container -->

<!--
	<div id="footer-container">
		<footer class="wrapper">
			<h3>footer</h3>
		</footer>
	</div>
-->
</body>
<script type="text/javascript">
	if (Modernizr.localStorage){
		//local storage is available
	}else{
		//output coupons will not be saved :( 
	}
		
	
	var runApp = function(){
		//creating streaming connection for future use case
				
		try{
		
			var ws = new WebSocket("ws://10.0.0.1:8080/activate");
			ws.onopen = function() {
			  $('#status').html('connection established...'); 	
			  		   
			};
			ws.onmessage = function (evt)
			{
			  
			};
			ws.onclose = function()
			{
			  // websocket is closed.
			  retry();
			};
		}catch(e) {
			retry();
		}
		
		//retrieve current offers available from kiosk
		$.ajax({
		  url: '/coupon',
		  dataType:'json',
		  cache:'false',
		  //data: data,
		  success: function(data){
		  	  
		  	  $('#couponCount').html(localStorage.length);
		  	  
		      var d = $('#article');
		      d.find('section').remove();
		      for(var key in data){
		      	var str = '';
		      	if(localStorage.getItem(key)===null){
			      	str = '<section id="'+ key+'">'+
					'	<div class="check-inactive" style="position:absolute;"><img src="{{ static_url("img/check.png")}}"></img></div>'+
					'	<div class="coupon-inner">'+
					//'		<img src="data:image/jpeg;base64,'+data[key]+'" />'+				
					'	</div>'+
					'</section>';
				}else{
				  	str = '<section id="'+key+'" class="active">'+
					'<div class="check-active" style="position:absolute;"><img src="{{ static_url("img/check.png")}}"></img></div>'+
					'	<div class="coupon-inner inactive">'+
					//'		<img class="coupon-image" src="data:image/jpeg;base64,'+data[key]+'"></img>'+
					'	</div>'+
					'</section>';
				}
		      	d.append(str);
		      	var i = d.find('#'+key + ' .coupon-inner');
		      	if(localStorage.getItem(key) === null){
			      	i.append('<img class="base64-coupon" src="data:image/jpeg;base64,'+data[key]+'" style="width:'+i.width()+'" />');
				}else{
				  	i.append('<img class="base64-coupon coupon-image" src="data:image/jpeg;base64,'+data[key]+'" style="width:'+i.width()+'" />');
				}      	
		      }
		  },
		  error: function(e){
		  	$('#status').html('waiting for kiosk');
		  }
		  
		});
		
	}
	
	var retry = function(){
		$('#status').html('waiting for connection...');
		setTimeout(runApp, 1000);
	}
	
		
	//setup global handlers
	$('#myCoupons').click(function(e){
			e.preventDefault();
			localStorage.clear();
			alert('reset offers');
			$('#couponCount').html(localStorage.length);
		  	  
	});
	var handler = $('#article').delegate('section', 'click', function(e){
			//todo:update local storage
			elem = $(this);		
				
			var srcImage = elem.find('.base64-coupon')[0].src;
			localStorage.setItem(elem[0].id,elem[0].src);
			$('#couponCount').html(localStorage.length);
			var str = '<div class="check-active" style="position:absolute;"><img src="{{ static_url("img/check.png")}}"></img></div>'+
					'	<div class="coupon-inner inactive">'+
					//'		<img class="coupon-image" src="data:image/jpeg;base64,'+data[key]+'"></img>'+
					'	</div>';	
			elem.addClass('active');
			elem.html(str);
			var i = elem.find('.coupon-inner');
			i.append('<img class="coupon-image" src="'+srcImage+'" style="width:'+i.width()+'" />');
			
	});
	
	$(document).ready(function(){
		runApp();
	});
</script>


</html>
